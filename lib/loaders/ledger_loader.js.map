{
  "version": 3,
  "sources": [
    "ledger_loader.js"
  ],
  "names": [
    "R",
    "require",
    "contained",
    "path",
    "getFS",
    "splitAndTrim",
    "isTime",
    "isConnector",
    "Transaction",
    "isRelativePath",
    "LEDGER_COMMENTS",
    "LEDGER_LINE_COMMENT",
    "Entry",
    "trimRight",
    "val",
    "isCommentChar",
    "isLeadingCommentLine",
    "slice",
    "stripLeadingCommentLines",
    "reject",
    "isCommentLine",
    "trimLeft",
    "isNumeric",
    "isNewTransactionLine",
    "isAccountKey",
    "addEqualsConnector",
    "insert",
    "lineCommentSpaces",
    "isCommentToken",
    "startsWith",
    "lastTokenIsComment",
    "last",
    "findConnector",
    "findIndex",
    "shortcutFromLedgerLine",
    "line",
    "clean",
    "replace",
    "parts",
    "tokenizeShortcut",
    "comment",
    "pop",
    "account",
    "shift",
    "length",
    "connectorIx",
    "push",
    "join",
    "convertLedgerTransaction",
    "lines",
    "header",
    "utc",
    "split",
    "status",
    "party",
    "extra",
    "address",
    "notes",
    "props",
    "entryLines",
    "forEach",
    "linetext",
    "indexOf",
    "key",
    "toLowerCase",
    "lastLine",
    "entries",
    "map",
    "tx",
    "note",
    "loadLedgerTransactions",
    "raw",
    "linesets",
    "accum",
    "isEmpty",
    "loadTransactionsFromFilenameSync",
    "fname",
    "directory",
    "link",
    "normalize",
    "readFileSync",
    "module",
    "exports"
  ],
  "mappings": "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",
  "file": "ledger_loader.js",
  "sourceRoot": "../../src/loaders",
  "sourcesContent": [
    "/* eslint no-unused-vars: off */\n\nconst R = require('ramda');\nconst { contained } = require('ramda-adjunct');\nconst path = require('path');\n\nconst { getFS } = require('./common');\nconst { splitAndTrim, isTime, isConnector } = require('../utils/models');\nconst Transaction = require('../models/transaction');\nconst { isRelativePath } = require('../utils/files');\nconst { LEDGER_COMMENTS, LEDGER_LINE_COMMENT } = require('../models/constants')\nconst Entry = require('../models/entry');\n\nconst trimRight = val => val.trimRight;\nconst isCommentChar = contained(LEDGER_COMMENTS);\nconst isLeadingCommentLine = val => isCommentChar(val.slice(0, 1));\nconst stripLeadingCommentLines = R.reject(isLeadingCommentLine);\nconst isCommentLine = val => isCommentChar(val.trimLeft().slice(0, 1));\nconst isNumeric = contained('0123456789');\nconst isNewTransactionLine = val => isNumeric(val.slice(0, 1));\nconst isAccountKey = contained(['id', 'account', 'note', 'status', 'address', 'party']);\nconst addEqualsConnector = R.insert(0, '=');\nconst lineCommentSpaces = /\\; */;\nconst isCommentToken = R.startsWith(LEDGER_LINE_COMMENT);\nconst lastTokenIsComment = (val) => isCommentToken(R.last(val));\nconst findConnector = R.findIndex(isConnector);\n\nfunction shortcutFromLedgerLine(line) {\n  const clean = line\n        .replace(lineCommentSpaces, ';')\n        .replace(/@@/g, '=');\n  let parts = Entry.tokenizeShortcut(clean);\n  const comment = lastTokenIsComment(parts) ? parts.pop() : null;\n  const account = parts.shift();\n  if (parts.length <= 3) {\n    // in Ledger format, if it is a single-posting, then it is a debit\n    // so use the leading-equals shortcut for that.\n    parts = addEqualsConnector(parts);\n  }\n\n  const connectorIx = findConnector(parts);\n  if (connectorIx) {\n    parts = R.insert(connectorIx, account, parts);\n  } else {\n    parts.push(account);\n  }\n\n  if (comment) {\n    parts.push(comment);\n  }\n  return parts.join(' ');\n}\n\nfunction convertLedgerTransaction(lines) {\n  const header = splitAndTrim(lines.shift());\n  // get the utc, replacing / with -.\n  let utc = header.shift().split('/').join('-');\n  let status = '';\n\n  // has time?\n  if (header[0].length > 1 && isTime(header[0])) {\n    utc = `${utc} ${header.shift()}`;\n  }\n  if (header[0].length === 1 && header.length > 1) {\n    status = header.shift();\n    if (status === '*') {\n      status = 'cleared';\n    }\n  }\n  const party = header.join(' ');\n  const extra = {};\n  let account = '';\n  const address = '';\n  const notes = [];\n  const props = {};\n  const entryLines = [];\n  // process comment lines first, so that all we will have left are entries\n  lines.forEach((line) => {\n    if (!isLeadingCommentLine(line)) {\n      entryLines.push(line);\n    } else {\n      const linetext = line.slice(1);\n      if (line.indexOf(':') === -1) {\n        notes.push(linetext);\n      } else {\n        const parts = linetext.split(':');\n        const key = parts[0].toLowerCase();\n        const val = parts.slice(1).join(':');\n        if (key === 'notes') {\n          notes.push(val);\n        } else if (isAccountKey(key)) {\n          props[key] = val;\n        } else {\n          extra[key] = val;\n        }\n      }\n    }\n  });\n  // check to see if we have a default account\n  if (entryLines.length > 0) {\n    const lastLine = entryLines[entryLines.length - 1];\n    if (lastLine.indexOf(' ') === -1) {\n      // yes, this is an \"elided\" Ledger entry\n      account = entryLines.pop();\n    }\n  }\n\n  const entries = entryLines.map(shortcutFromLedgerLine);\n\n  const tx = {\n    ...props,\n    utc,\n    status,\n    party,\n    account,\n    address,\n    note: notes.join('\\n'),\n    extra,\n    entries,\n  };\n  //console.log('new TX:', JSON.stringify(tx, null, 2));\n  return new Transaction(tx);\n}\n\nfunction loadLedgerTransactions(raw) {\n  const lines = raw.replace(/\\r/g, '').split('\\n');\n  const linesets = [];\n  let accum = [];\n\n  stripLeadingCommentLines(lines).forEach((line) => {\n    const clean = line.trimRight();\n    if (!R.isEmpty(clean)) {\n      if (isNewTransactionLine(line) && accum.length > 0) {\n        linesets.push(accum);\n        accum = [line];\n      } else {\n        accum.push(clean.trimLeft());\n      }\n    }\n  });\n  if (accum.length > 0) {\n    linesets.push(accum);\n  }\n\n  // now we have an array of \"linesets\" which each are a transaction, hopefully.\n  return linesets.map(convertLedgerTransaction);\n}\n\nfunction loadTransactionsFromFilenameSync(fname, directory) {\n  let link = fname;\n  if (directory && isRelativePath(fname)) {\n    link = path.normalize(`${directory}/${fname}`);\n  }\n  return loadLedgerTransactions(getFS().readFileSync(link, 'utf-8'));\n}\n\nmodule.exports = {\n  shortcutFromLedgerLine,\n  loadTransactionsFromFilenameSync,\n  loadLedgerTransactions,\n  convertLedgerTransaction,\n};\n"
  ]
}
