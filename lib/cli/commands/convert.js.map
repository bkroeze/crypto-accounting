{
  "version": 3,
  "sources": [
    "convert.js"
  ],
  "names": [
    "R",
    "require",
    "BigNumber",
    "path",
    "moment",
    "fs",
    "log",
    "get",
    "Transaction",
    "parseWalletCSV",
    "rowToYaml",
    "mergeTransactionLists",
    "ledgerLoader",
    "flexibleLoadByExtSync",
    "ascendingDate",
    "ascend",
    "prop",
    "descendingDate",
    "descend",
    "readCSV",
    "filename",
    "currency",
    "debit",
    "credit",
    "readFileSync",
    "toString",
    "readJSON",
    "base",
    "cb",
    "raw",
    "work",
    "JSON",
    "parse",
    "results",
    "map",
    "row",
    "date",
    "time",
    "address",
    "label",
    "amount",
    "reject",
    "readLedger",
    "loadTransactionsFromFilenameSync",
    "printResults",
    "descending",
    "byDay",
    "startDate",
    "searchDate",
    "console",
    "length",
    "filter",
    "x",
    "isSameOrBefore",
    "utc",
    "sorter",
    "sorted",
    "sort",
    "current",
    "forEach",
    "clone",
    "startOf",
    "isSame",
    "plus",
    "toFixed",
    "push",
    "line",
    "toYaml",
    "e",
    "name",
    "handler",
    "args",
    "merge",
    "existsSync",
    "process",
    "exit",
    "replace",
    "processed",
    "endsWith",
    "orig",
    "start",
    "builder",
    "yargs",
    "option",
    "default",
    "type",
    "desc",
    "positional",
    "module",
    "exports",
    "command"
  ],
  "mappings": "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",
  "file": "convert.js",
  "sourceRoot": "../../../src/cli/commands",
  "sourcesContent": [
    "const R = require('ramda');\nconst BigNumber = require('bignumber.js');\nconst path = require('path');\nconst moment = require('moment');\nconst fs = require('graceful-fs');\nconst log = require('js-logger').get('cli.commands.convert');\n\nconst Transaction = require('../../models/transaction');\nconst { parseWalletCSV, rowToYaml, mergeTransactionLists } = require('../../loaders/csv_converter');\nconst ledgerLoader = require('../../loaders/ledger_loader');\nconst { flexibleLoadByExtSync } = require('../../loaders/yaml_loader');\n\nconst ascendingDate = R.ascend(R.prop('utc'));\nconst descendingDate = R.descend(R.prop('utc'));\n\nfunction readCSV(filename, currency, debit, credit) {\n  return parseWalletCSV(\n    fs.readFileSync(filename).toString(),\n    currency,\n    debit,\n    credit);\n}\n\nfunction readJSON(filename, base, cb) {\n  let raw = fs.readFileSync(filename).toString();\n  //const re = /\\\"amount\\\" : (.*),/g\n  // quote the amount, so that we don't lose precision\n  //raw = raw.replace(re, '\"Amount\" : \"$1\"');\n  const work = JSON.parse(raw);\n  let results = work.map(row => {\n    return {\n      date: moment(row.time * 1000),\n      address: row.address,\n      label: base,\n      amount: row.amount,\n    };\n  });\n  return R.reject((row) => row.amount === 0, results);\n}\n\nfunction readLedger(filename) {\n  return ledgerLoader.loadTransactionsFromFilenameSync(filename);\n}\n\nfunction printResults(results, base, credit, debit, descending, byDay, startDate) {\n  let work = results;\n  //console.log(work);\n  if (startDate) {\n    const searchDate = moment(startDate);\n    console.log('filtering for startDate', results.length)\n    work = results.filter(x => searchDate.isSameOrBefore(x.utc));\n    console.log('trimmed to', results.length);\n  }\n  const sorter = descending ? descendingDate : ascendingDate;\n  let sorted = R.sort(sorter, work);\n  if (byDay) {\n    const work = [];\n    let current;\n    sorted.forEach(row => {\n      if (!current) {\n        current = R.clone(row);\n        current.date = current.date.startOf('day');\n        current.amount = BigNumber(current.amount);\n      } else if (current.date.isSame(row.date, 'day') && row.address === current.address) {\n        current.amount = current.amount.plus(BigNumber(row.amount));\n      } else {\n        current.amount = current.amount.toFixed(8);\n        work.push(current);\n        current = R.clone(row);\n        current.date = current.date.startOf('day');\n        current.amount = BigNumber(current.amount);\n      }\n    });\n    work.push(current);\n    sorted = work;\n  }\n  sorted.forEach(row => {\n    let line;\n    try {\n      line = row.toYaml(byDay);\n    } catch (e) {\n      if (e.name === 'TypeError') {\n        line = row.toYaml(byDay);\n      } else {\n        throw e;\n      }\n    }\n    console.log(line);\n  });\n  return true;\n}\n\nfunction handler(args) {\n  const {merge, filename, currency, credit, descending} = args;\n  if (!fs.existsSync(filename)) {\n    console.log(`File not found: ${filename}`);\n    process.exit(1);\n  }\n\n  if (merge && !fs.existsSync(merge)) {\n    console.log(`Merge file not found: ${merge}`);\n    process.exit(1);\n  }\n\n  const debit = args.debit.replace('{CURRENCY}', currency);\n\n  let processed;\n  if (R.endsWith('.csv', filename)) {\n    if (!currency) {\n      console.log('Please specify a --currency');\n      process.exit(1);\n    }\n    processed = readCSV(filename, currency, debit, credit);\n  } else if (R.endsWith('.json', filename)) {\n    if (!currency) {\n      console.log('Please specify a --currency');\n      process.exit(1);\n    }\n    processed = readJSON(filename, currency);\n  } else if (R.endsWith('.dat', filename)) {\n    processed = readLedger(filename);\n  }\n\n  let work;\n  if (!merge) {\n    work = processed;\n  } else {\n    const orig = readLedger(merge);\n    work = mergeTransactionLists(orig, processed);\n  }\n  printResults(work, currency, credit, debit, descending, args.byDay, args.start);\n}\n\nfunction builder(yargs) {\n  return yargs\n    .option('credit', {default: 'Income:Crypto:MN'})\n    .option('debit', {default: 'Assets:Crypto:Wallets:{CURRENCY}'})\n    .option('descending', {type: 'boolean', desc: 'Sort in descending date order', default: false})\n    .option('byDay', {type: 'boolean', desc: 'Bucket similar transactions by day', default: false})\n    .option('start', {type: 'string', desc: 'Starting date', default: false})\n    .option('currency', {type: 'string', desc: 'Which symbol for this conversion. EX: BTC'})\n    .option('merge', {type: 'string', desc: 'Merge with existing YAML file'})\n    .positional('filename', {type: 'string', desc: 'CSV file to read'});\n}\n\nmodule.exports = {\n  command: {\n    command: 'convert <filename>',\n    desc: 'Convert CSV, Ledger or JSON to Yaml-Transaction format',\n    builder,\n    handler,\n  }\n};\n"
  ]
}
